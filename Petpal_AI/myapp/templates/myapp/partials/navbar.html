{% load static %}
{% load tailwind_tags %}
<nav x-data="{ open: false, chatOpen: false }" class="sticky top-0 z-50 shadow-md" aria-label="Primary">
  <style>[x-cloak]{display:none !important}</style>

  <div class="bg-gradient-to-r from-orange-400 to-orange-500">
    <div class="w-full px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">

      <div class="flex items-center gap-6">
        
        <a href="{% url 'landing' %}" class="flex items-center gap-3">
          <img src="{% static 'images/logo.png' %}" alt="Petpal AI" class="h-14 w-14 rounded p-1">
          <span class="hidden sm:block font-semibold text-white tracking-wide">Petpal AI</span>
        </a>

        <div x-data="chatApp()" class="relative" @keydown.escape.window="isOpen = false">
          <button @click="toggleChat()" 
                  class="flex items-center gap-2 bg-white/20 hover:bg-white/30 text-white px-3 py-2 rounded-full transition backdrop-blur-sm border border-white/30 shadow-sm group">
             <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                <path d="M12 2a3 3 0 0 0-3 3v1h6V5a3 3 0 0 0-3-3z" opacity="0.6"/>
                <path fill-rule="evenodd" d="M2 12c0-4.418 4.477-8 10-8s10 3.582 10 8c0 1.5-.5 2.9-1.4 4.1l1.1 3.3a1 1 0 0 1-1.3 1.3l-3.3-1.1c-1.4.8-3.1 1.4-5.1 1.4-5.523 0-10-3.582-10-8zm7-1a1 1 0 1 0 0 2 1 1 0 0 0 0-2zm6 0a1 1 0 1 0 0 2 1 1 0 0 0 0-2z" clip-rule="evenodd" />
             </svg>
             <span class="text-sm font-medium hidden lg:block">AI Assistant</span>
          </button>

          <div x-show="isOpen" 
               x-transition:enter="transition ease-out duration-200"
               x-transition:enter-start="opacity-0 translate-y-2"
               x-transition:enter-end="opacity-100 translate-y-0"
               x-transition:leave="transition ease-in duration-150"
               x-transition:leave-start="opacity-100 translate-y-0"
               x-transition:leave-end="opacity-0 translate-y-2"
               @click.outside="isOpen = false"
               x-cloak
               class="absolute top-full left-0 mt-3 w-80 md:w-96 bg-white rounded-2xl shadow-2xl border border-gray-200 overflow-hidden flex flex-col z-[100]">

            <div class="bg-gradient-to-r from-orange-500 to-yellow-400 p-3 flex justify-between items-center text-white">
              <div class="flex items-center gap-2">
                <div class="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center">ü§ñ</div>
                <span class="font-bold text-sm">Petpal Assistant</span>
              </div>
              <a href="{% url 'ai_chat_page' %}" class="hover:bg-white/20 p-1 rounded transition" title="‡∏Ç‡∏¢‡∏≤‡∏¢‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                  <path fill-rule="evenodd" d="M4.25 2A2.25 2.25 0 002 4.25v2.5a.75.75 0 001.5 0v-2.5a.75.75 0 01.75-.75h2.5a.75.75 0 000-1.5h-2.5zM13.25 2a.75.75 0 000 1.5h2.5a.75.75 0 01.75.75v2.5a.75.75 0 001.5 0v-2.5A2.25 2.25 0 0015.75 2h-2.5zM2.75 13.25a.75.75 0 00-1.5 0v2.5A2.25 2.25 0 004.25 18h2.5a.75.75 0 000-1.5h-2.5a.75.75 0 01-.75-.75v-2.5zM17.25 13.25a.75.75 0 00-1.5 0v2.5a.75.75 0 01-.75.75h-2.5a.75.75 0 000 1.5h2.5A2.25 2.25 0 0018 15.75v-2.5z" clip-rule="evenodd" />
                </svg>
              </a>
            </div>

            <div class="h-72 bg-gray-50 p-3 overflow-y-auto space-y-2" id="chat-scroll" x-ref="chatScroll">
              <template x-for="msg in messages">
                <div :class="msg.sender === 'ai' ? 'flex justify-start' : 'flex justify-end'">
                  <div :class="msg.sender === 'ai' ? 'bg-white border border-gray-200 text-gray-700 rounded-2xl rounded-tl-none px-3 py-2 shadow-sm text-sm max-w-[90%]' : 'bg-orange-100 text-orange-900 rounded-2xl rounded-tr-none px-3 py-2 shadow-sm text-sm max-w-[90%]'">
                    <span x-text="msg.text"></span>
                  </div>
                </div>
              </template>
              <template x-if="loading">
                <div class="flex justify-start">
                  <div class="bg-white border border-gray-200 text-gray-400 rounded-2xl rounded-tl-none px-3 py-2 shadow-sm text-sm max-w-[90%] animate-pulse">
                    ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏≠‡∏ö...
                  </div>
                </div>
              </template>
            </div>

            <div class="p-3 bg-white border-t border-gray-100">
              <form class="flex gap-2" @submit.prevent="sendMessage">
                <input type="text" x-model="userInput" placeholder="‡∏ñ‡∏≤‡∏° AI..." class="flex-1 bg-gray-100 border-0 rounded-full px-3 py-1.5 text-sm focus:ring-1 focus:ring-orange-500" :disabled="loading">
                <button type="submit" class="bg-orange-500 text-white p-1.5 rounded-full hover:bg-orange-600" :disabled="loading">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4">
                    <path d="M3.478 2.404a.75.75 0 00-.926.941l2.432 7.905H13.5a.75.75 0 010 1.5H4.984l-2.432 7.905a.75.75 0 00.926.94 60.519 60.519 0 0018.445-8.986.75.75 0 000-1.218A60.517 60.517 0 003.478 2.404z" />
                  </svg>
                </button>
              </form>
            </div>

          </div>
        </div>
        </div>
      <div class="hidden md:flex items-center gap-6">
        <a href="{% url 'landing' %}" class="text-white/90 hover:text-white hover:underline underline-offset-4">home</a>
        <a href="{% url 'adoption_list' %}" class="text-white/90 hover:text-white hover:underline underline-offset-4">‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏´‡∏≤‡∏ö‡πâ‡∏≤‡∏ô</a>
        <a href="{% url 'lost_list' %}" class="text-white/90 hover:text-white hover:underline underline-offset-4">‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏´‡∏≤‡∏¢</a>
        <a href="{% url 'contact_list' %}" class="text-white/90 hover:text-white hover:underline underline-offset-4">‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</a>

        {% if request.user.is_authenticated %}
        <a href="{% url 'my_posts_list' %}" class="text-white/90 hover:text-white hover:underline underline-offset-4 flex items-center gap-1">
           <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
             <path d="M7 3a1 1 0 000 2h6a1 1 0 100-2H7zM4 7a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zM2 11a2 2 0 002-2h12a2 2 0 012 2v4a2 2 0 01-2 2H4a2 2 0 01-2-2v-4z" />
           </svg>
           <span>‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</span>
        </a>

        <a href="{% url 'adoption_requests_list' %}" class="text-white/90 hover:text-white hover:underline underline-offset-4 flex items-center gap-1">
           <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
             <path d="M3 4a2 2 0 00-2 2v1.161l8.441 4.221a1.25 1.25 0 001.118 0L19 7.162V6a2 2 0 00-2-2H3z" />
             <path d="M19 8.839l-7.77 3.885a2.75 2.75 0 01-2.46 0L1 8.839V14a2 2 0 002 2h14a2 2 0 002-2V8.839z" />
           </svg>
           <span>‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏à‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏Ñ‡∏≥‡∏Ç‡∏≠</span>
        </a>
        {% endif %}

        {% if request.user.is_authenticated %}
          <div x-data="{dd:false}" class="relative" @keydown.escape.window="dd=false">
            <button @click="dd=!dd" class="inline-flex items-center gap-2 rounded-full bg-white/15 px-2 py-1 hover:bg-white/25 text-white">
              <span class="h-8 w-8 rounded-full bg-white text-neutral-800 grid place-items-center font-semibold">
                {{ request.user.username|first|upper }}
              </span>
              <span class="hidden sm:block">{{ request.user.username }}</span>
              <svg class="h-4 w-4 opacity-80" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.11l3.71-3.88a.75.75 0 111.08 1.04l-4.24 4.43a.75.75 0 01-1.08 0L5.21 8.27a.75.75 0 01.02-1.06z" clip-rule="evenodd"/>
              </svg>
            </button>

            <div x-show="dd" x-transition x-cloak @click.outside="dd=false"
                 class="absolute right-0 mt-2 w-48 rounded-md bg-white shadow-lg ring-1 ring-black/5 overflow-hidden text-left">
              <a href="{% url 'profile' %}" class="block px-4 py-2 text-sm text-neutral-700 hover:bg-neutral-100">‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</a>
              <form method="post" action="{% url 'logout' %}?next={% url 'landing' %}">
                {% csrf_token %}
                <button type="submit"
                  class="block w-full text-left px-4 py-2 text-sm text-neutral-700 hover:bg-neutral-100">
                  ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
                </button>
              </form>
            </div>
          </div>
        {% else %}
          <a href="{% url 'login' %}"
             class="inline-flex items-center rounded-md bg-black/80 px-4 py-2 text-sm font-medium text-white hover:bg-black">
            Login
          </a>
        {% endif %}
      </div>

      <button @click="open = !open"
              class="md:hidden inline-flex items-center justify-center rounded-md bg-black/10 px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-white/60"
              aria-controls="mobile-menu" :aria-expanded="open">
        <svg x-show="!open" x-cloak xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none"
             viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
             d="M4 6h16M4 12h16M4 18h16"/></svg>
        <svg x-show="open" x-cloak xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none"
             viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
             d="M6 18L18 6M6 6l12 12"/></svg>
      </button>
    </div>
  </div>

  <div id="mobile-menu" x-show="open" x-transition.origin.top x-cloak class="md:hidden bg-white">
    <div class="space-y-1 px-4 py-3">
      <a href="{% url 'landing' %}" class="block rounded-md px-3 py-2 text-neutral-800 hover:bg-neutral-100" @click="open=false">home</a>
      <a href="{% url 'adoption_list' %}" class="block rounded-md px-3 py-2 text-neutral-800 hover:bg-neutral-100" @click="open=false">‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏´‡∏≤‡∏ö‡πâ‡∏≤‡∏ô</a>
      <a href="{% url 'lost_list' %}" class="block rounded-md px-3 py-2 text-neutral-800 hover:bg-neutral-100" @click="open=false">‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏´‡∏≤‡∏¢</a>
      <a href="{% url 'contact_list' %}" class="block rounded-md px-3 py-2 text-neutral-800 hover:bg-neutral-100" @click="open=false">‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</a>
      
      {% if request.user.is_authenticated %}
      <a href="{% url 'my_posts_list' %}" class="text-neutral-800 hover:bg-neutral-100 block rounded-md px-3 py-2 flex items-center gap-2" @click="open=false">
           <span>üìù</span> ‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô
      </a>
      <a href="{% url 'adoption_requests_list' %}" class="text-neutral-800 hover:bg-neutral-100 block rounded-md px-3 py-2 flex items-center gap-2" @click="open=false">
        <span>‚úâÔ∏è</span> ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏à‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏Ñ‡∏≥‡∏Ç‡∏≠
      </a>
      {% endif %}

      <div class="border-t pt-3 mt-2">
        {% if request.user.is_authenticated %}
          <a href="{% url 'profile' %}" class="block rounded-md px-3 py-2 text-neutral-800 hover:bg-neutral-100" @click="open=false">‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</a>
          <form method="post" action="{% url 'logout' %}?next={% url 'landing' %}">
            {% csrf_token %}
            <button type="submit" class="block w-full text-left rounded-md px-3 py-2 text-neutral-800 hover:bg-neutral-100" @click="open=false">
              ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
            </button>
          </form>
        {% else %}
          <a href="{% url 'login' %}"
             class="block rounded-md bg-neutral-900 px-3 py-2 text-center text-white hover:opacity-90" @click="open=false">Login</a>
        {% endif %}
      </div>
    </div>
  </div>
</nav>

<script>
function chatApp() {
    return {
        isOpen: false,
        userInput: '',
        loading: false,
        messages: [
            { text: "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö! üò∫ ‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡πÉ‡∏´‡πâ PetBot ‡∏ä‡πà‡∏ß‡∏¢‡πÑ‡∏´‡∏°‡∏Ñ‡∏£‡∏±‡∏ö?", sender: 'ai' }
        ],

        toggleChat() {
            this.isOpen = !this.isOpen;
            if(this.isOpen) setTimeout(() => this.scrollToBottom(), 100);
        },

        sendMessage() {
            if (this.userInput.trim() === '') return;
            const text = this.userInput;
            this.userInput = '';
            this.loading = true;
            this.addMessage(text, 'user');

            fetch('/api/chat/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: text })
            })
            .then(res => res.json())
            .then(data => {
                this.addMessage(data.response, 'ai');
            })
            .catch(() => {
                this.addMessage('‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢ ‡∏£‡∏∞‡∏ö‡∏ö‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß', 'ai');
            })
            .finally(() => {
                this.loading = false;
                setTimeout(() => this.scrollToBottom(), 100);
            });
        },

        addMessage(text, sender) {
            this.messages.push({ text, sender });
            setTimeout(() => this.scrollToBottom(), 100);
        },

        scrollToBottom() {
            this.$refs.chatScroll.scrollTop = this.$refs.chatScroll.scrollHeight;
        }
    }
}
</script>