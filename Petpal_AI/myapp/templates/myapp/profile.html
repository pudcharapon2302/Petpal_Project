{% load static %}
<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Profile</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body class="min-h-screen bg-gray-100">

  <!-- Navbar -->
  {% include "myapp/partials/navbar.html" %}

  <main class="max-w-6xl mx-auto px-4 py-8 grid md:grid-cols-3 gap-6"
        x-data="{ showEdit:false, showAddPet:false }">

    <!-- Left: Profile card -->
    <section class="md:col-span-1">
      <div class="rounded-2xl p-6 bg-gradient-to-b from-gray-800 to-gray-700 text-white shadow-lg">
        <div class="flex flex-col items-center">
          <div class="relative">
            {% if profile.avatar %}
              <img src="{{ profile.avatar.url }}" alt="avatar"
                   class="w-40 h-40 object-cover rounded-full ring-4 ring-white/20" />
            {% else %}
              <img src="{% static 'img/default-avatar.jpg' %}" alt="avatar"
                   class="w-40 h-40 object-cover rounded-full ring-4 ring-white/20" />
            {% endif %}
          </div>
          <h2 class="mt-5 text-xl font-semibold">
            {% if request.user.first_name %}{{ request.user.first_name }}{% else %}{{ request.user.username }}{% endif %}
          </h2>
          <button @click="showEdit=true"
                  class="mt-4 px-4 py-2 bg-white text-gray-800 rounded-xl shadow hover:shadow-md">
            Edit Profile
          </button>
        </div>

        <div class="mt-6 space-y-4">
          <div>
            <label class="block text-sm text-white/70">Phone</label>
            <div class="mt-1 bg-white/10 rounded-xl px-4 py-2">{{ request.user.phone|default:"-" }}</div>
          </div>
          <div>
            <label class="block text-sm text-white/70">Address</label>
            <div class="mt-1 bg-white/10 rounded-xl px-4 py-2 whitespace-pre-line">
              {{ request.user.address|default:"-" }}
            </div>
          </div>
        </div>

        <div class="mt-6 flex items-center gap-3">
          <button class="flex-1 px-4 py-2 rounded-xl bg-white/10">Request</button>
          <a href="{% url 'logout' %}" class="flex-1 text-center px-4 py-2 rounded-xl bg-red-500">Sign out</a>
        </div>
      </div>
    </section>

    <!-- Right: Pets list -->
    <section class="md:col-span-2">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-2xl font-semibold">My pets</h3>
        <button @click="showAddPet=true"
                class="text-sm px-3 py-1 rounded-full bg-gray-900 text-white">
          + Add
        </button>
      </div>

      <div class="grid sm:grid-cols-2 gap-6">
        {% for pet in pets %}
          <article class="bg-white rounded-2xl shadow overflow-hidden">
            <div class="h-40 w-full overflow-hidden">
              {% if pet.image %}
                <img src="{{ pet.image.url }}" class="w-full h-40 object-cover" />
              {% else %}
                <img src="{% static 'img/pet-placeholder.jpg' %}" class="w-full h-40 object-cover" />
              {% endif %}
            </div>
            <div class="p-4">
              <div class="flex items-center gap-2">
                {% if profile.avatar %}
                  <img src="{{ profile.avatar.url }}" class="w-8 h-8 rounded-full object-cover" />
                {% else %}
                  <img src="{% static 'img/default-avatar.jpg' %}" class="w-8 h-8 rounded-full object-cover" />
                {% endif %}
                <h4 class="font-semibold">{{ pet.name }}</h4>
              </div>
              <p class="text-sm text-gray-600 mt-2">
                Birth Day : {{ pet.birth_date|date:"d/m/Y" }}
              </p>
            </div>
          </article>
        {% empty %}
          <div class="text-gray-500">ยังไม่มีสัตว์เลี้ยง ลองกด “Add” ที่มุมขวา</div>
        {% endfor %}
      </div>
    </section>

    <!-- Modal: Edit Profile (ดีไซน์ใหม่ + avatar preview) -->
    <div x-show="showEdit" x-cloak
         class="fixed inset-0 z-50 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4">
      <form method="post" action="{% url 'profile_update' %}" enctype="multipart/form-data"
            x-data="{
              avatarName: '',
              avatarUrl: '{% if profile.avatar %}{{ profile.avatar.url|escapejs }}{% else %}{% static 'img/default-avatar.jpg' %}{% endif %}',
              pickFile(e){ const f=e.target.files?.[0]; if(!f) return; this.avatarName=f.name; this.avatarUrl=URL.createObjectURL(f); }
            }"
            class="w-full max-w-2xl">
        {% csrf_token %}

        <div class="rounded-2xl overflow-hidden shadow-2xl">
          <div class="bg-gradient-to-r from-neutral-900 to-neutral-800 text-white px-6 py-4 flex items-center justify-between">
            <h3 class="text-xl font-semibold">Edit Profile</h3>
            <button type="button" @click="showEdit=false" class="rounded-md bg-white/10 px-3 py-1.5 hover:bg-white/20">✕</button>
          </div>

          <div class="bg-white px-6 py-6">
            <div class="grid grid-cols-1 md:grid-cols-[140px,1fr] gap-6 items-center mb-6">
              <div class="flex md:block justify-center">
                <img :src="avatarUrl || '{% static 'img/default-avatar.jpg' %}'"
                     alt="avatar preview"
                     class="h-28 w-28 rounded-full object-cover ring-4 ring-neutral-100 shadow" />
              </div>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <label class="block">
                  <span class="text-sm text-neutral-600">Full name</span>
                  <input name="full_name" type="text" value="{{ request.user.first_name }}"
                         placeholder="ชื่อที่จะแสดงในโปรไฟล์"
                         class="mt-1 w-full rounded-xl border border-neutral-300 bg-white px-3 py-2 focus:outline-none focus:ring-4 focus:ring-neutral-900/10 focus:border-neutral-900" />
                </label>

                <label class="block">
                  <span class="text-sm text-neutral-600">Avatar</span>
                  <input name="avatar" type="file" accept="image/*" @change="pickFile"
                         class="mt-1 block w-full text-sm file:mr-4 file:rounded-lg file:border-0 file:bg-neutral-900 file:px-4 file:py-2 file:text-white hover:file:opacity-90 cursor-pointer" />
                  <p class="mt-1 text-xs text-neutral-500 truncate" x-text="avatarName"></p>
                </label>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <label class="block">
                <span class="text-sm text-neutral-600">Phone</span>
                <input name="phone" type="text" value="{{ request.user.phone }}"
                       placeholder="เช่น 08xxxxxxxx"
                       class="mt-1 w-full rounded-xl border border-neutral-300 bg-white px-3 py-2 focus:outline-none focus:ring-4 focus:ring-neutral-900/10 focus:border-neutral-900" />
              </label>

              <label class="block md:col-span-2">
                <span class="text-sm text-neutral-600">Address</span>
                <textarea name="address" rows="3" placeholder="ที่อยู่สำหรับติดต่อ/จัดส่ง"
                          class="mt-1 w-full rounded-xl border border-neutral-300 bg-white px-3 py-2 focus:outline-none focus:ring-4 focus:ring-neutral-900/10 focus:border-neutral-900">{{ request.user.address }}</textarea>
              </label>
            </div>
          </div>

          <div class="bg-neutral-50 px-6 py-4 flex items-center justify-end gap-3">
            <button type="button" @click="showEdit=false" class="rounded-xl px-4 py-2 bg-neutral-200 hover:bg-neutral-300">Cancel</button>
            <button class="rounded-xl px-5 py-2.5 bg-neutral-900 text-white hover:opacity-90 shadow">Save</button>
          </div>
        </div>
      </form>
    </div>

    <!-- Modal: Add Pet -->
    <div x-show="showAddPet" x-cloak
         class="fixed inset-0 bg-black/40 flex items-center justify-center p-4">
      <form method="post" action="{% url 'pet_create' %}" enctype="multipart/form-data"
            class="bg-white rounded-2xl w-full max-w-lg p-6 space-y-4">
        {% csrf_token %}
        <h3 class="text-xl font-semibold">Add Pet</h3>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm text-gray-600">Name</label>
            <input name="name" type="text" class="mt-1 w-full rounded-xl border-gray-300" required />
          </div>
          <div>
            <label class="block text-sm text-gray-600">Birth date</label>
            <input name="birth_date" type="date" class="mt-1 w-full rounded-xl border-gray-300" />
          </div>
        </div>

        <div>
          <label class="block text-sm text-gray-600">Photo</label>
          <input name="image" type="file" accept="image/*" class="mt-1 w-full rounded-xl border-gray-300" />
        </div>

        <div class="flex justify-end gap-2 pt-2">
          <button type="button" @click="showAddPet=false" class="px-4 py-2 rounded-xl bg-gray-200">Cancel</button>
          <button class="px-4 py-2 rounded-xl bg-gray-900 text-white">Save</button>
        </div>
      </form>
    </div>

  </main>
</body>
</html>