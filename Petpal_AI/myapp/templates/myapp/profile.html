{% load static %}
{% load tailwind_tags %}  <!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Profile</title>
  {% tailwind_css %} <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body class="min-h-screen bg-gray-100">

  <!-- Navbar -->
  {% include "myapp/partials/navbar.html" %}

  <main class="max-w-6xl mx-auto px-4 py-8 grid md:grid-cols-3 gap-6"
        x-data="{ showEdit:false, showDelete:false, delInput:'' }">

    <!-- Left: Profile card -->
    <section class="md:col-span-1">
      <div class="rounded-2xl p-6 bg-gradient-to-b from-gray-800 to-gray-700 text-white shadow-lg">
        <div class="flex flex-col items-center">
          <div class="relative">
            {% if profile.avatar %}
              <img src="{{ profile.avatar.url }}" alt="avatar"
                   class="w-40 h-40 object-cover rounded-full ring-4 ring-white/20" />
            {% else %}
              <img src="{% static 'img/default-avatar.jpg' %}" alt="avatar"
                   class="w-40 h-40 object-cover rounded-full ring-4 ring-white/20" />
            {% endif %}
          </div>
          <h2 class="mt-5 text-xl font-semibold">
            {% if request.user.first_name %}{{ request.user.first_name }}{% else %}{{ request.user.username }}{% endif %}
          </h2>
          <button @click="showEdit=true"
                  class="mt-4 px-4 py-2 bg-white text-gray-800 rounded-xl shadow hover:shadow-md">
            Edit Profile
          </button>
        </div>

        <div class="mt-6 space-y-4">
          <div>
            <label class="block text-sm text-white/70">Phone</label>
            <div class="mt-1 bg-white/10 rounded-xl px-4 py-2">{{ request.user.phone|default:"-" }}</div>
          </div>
          <div>
            <label class="block text-sm text-white/70">Address</label>
            <div class="mt-1 bg-white/10 rounded-xl px-4 py-2 whitespace-pre-line">
              {{ request.user.address|default:"-" }}
            </div>
          </div>
        </div>

        <div class="mt-6 grid grid sm:grid-cols-3 gap-3">
          <button class="px-4 py-2 items-center rounded-xl bg-white/10">Request</button>
          <!-- ปุ่มลบบัญชี -->
          <button type="button" @click="showDelete=true"
                  class="px-4 py-2 rounded-xl border border-red-300 bg-red-50 text-red-600 hover:bg-red-100">
            Delete account
          </button>
        </div>
      </div>
    </section>

    <!-- Right: Pets list -->
    <section class="md:col-span-2">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-2xl font-semibold">My pets</h3>
        <a href="{% url 'pet_add' %}"
           class="text-sm px-3 py-1 rounded-full bg-gray-900 text-white">+ Add</a>
      </div>

      <div class="grid sm:grid-cols-2 gap-6">
        {% for pet in pets %}
          <!-- ครอบการ์ดทั้งใบด้วยลิงก์ ไปหน้า detail -->
          <a href="{% url 'pet_detail' pet.pk %}"
             class="block bg-white rounded-2xl shadow overflow-hidden hover:ring-2 hover:ring-gray-200">
            <!-- รูปด้านบน: ใช้ cover ก่อน > image > placeholder -->
            <div class="h-40 w-full overflow-hidden">
              {% if pet.cover_image %}
                <img src="{{ pet.cover_image.url }}" class="w-full h-40 object-cover" alt="{{ pet.name }}">
              {% elif pet.image %}
                <img src="{{ pet.image.url }}" class="w-full h-40 object-cover" alt="{{ pet.name }}">
              {% else %}
                <img src="{% static 'img/pet-placeholder.jpg' %}" class="w-full h-40 object-cover" alt="">
              {% endif %}
            </div>

            <div class="p-4">
              <div class="flex items-center gap-2">
                {% if pet.image %}
                  <img src="{{ pet.image.url }}" class="w-8 h-8 rounded-full object-cover ring-2 ring-white shadow" alt="">
                {% else %}
                  <img src="{% static 'img/default-avatar.jpg' %}" class="w-8 h-8 rounded-full object-cover" alt="">
                {% endif %}
                <h4 class="font-semibold">{{ pet.name }}</h4>
              </div>
              <p class="text-sm text-gray-600 mt-2">
                Type : {% if pet.animal %}{{ pet.animal.get_species_display|default:pet.animal.species }}{% else %}-{% endif %}<br>
                Breed : {% if pet.animal and pet.animal.breed %}{{ pet.animal.breed }}{% else %}-{% endif %}<br>
                Date of Birth : {{ pet.birth_date|date:"d/m/Y"|default:"-" }}
              </p>
            </div>
          </a>
        {% empty %}
          <div class="text-gray-500">ยังไม่มีสัตว์เลี้ยง ลองกด “Add” ที่มุมขวา</div>
        {% endfor %}
      </div>
    </section>

    <!-- Modal: Edit Profile -->
    <div x-show="showEdit" x-cloak
         class="fixed inset-0 z-50 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4">
      <form method="post" action="{% url 'profile_update' %}" enctype="multipart/form-data"
            x-data="{
              avatarName: '',
              avatarUrl: '{% if profile.avatar %}{{ profile.avatar.url|escapejs }}{% else %}{% static 'img/default-avatar.jpg' %}{% endif %}',
              pickFile(e){ const f=e.target.files?.[0]; if(!f) return; this.avatarName=f.name; this.avatarUrl=URL.createObjectURL(f); }
            }"
            class="w-full max-w-2xl">
        {% csrf_token %}

        <div class="rounded-2xl overflow-hidden shadow-2xl">
          <div class="bg-gradient-to-r from-neutral-900 to-neutral-800 text-white px-6 py-4 flex items-center justify-between">
            <h3 class="text-xl font-semibold">Edit Profile</h3>
            <button type="button" @click="showEdit=false" class="rounded-md bg-white/10 px-3 py-1.5 hover:bg-white/20">✕</button>
          </div>

          <div class="bg-white px-6 py-6">
            <div class="grid grid-cols-1 md:grid-cols-[140px,1fr] gap-6 items-center mb-6">
              <div class="flex md:block justify-center">
                <img :src="avatarUrl || '{% static 'img/default-avatar.jpg' %}'"
                     alt="avatar preview"
                     class="h-28 w-28 rounded-full object-cover ring-4 ring-neutral-100 shadow" />
              </div>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <label class="block">
                  <span class="text-sm text-neutral-600">Full name</span>
                  <input name="full_name" type="text" value="{{ request.user.first_name }}"
                         placeholder="ชื่อที่จะแสดงในโปรไฟล์"
                         class="mt-1 w-full rounded-xl border border-neutral-300 bg-white px-3 py-2 focus:outline-none focus:ring-4 focus:ring-neutral-900/10 focus:border-neutral-900" />
                </label>

                <label class="block">
                  <span class="text-sm text-neutral-600">Avatar</span>
                  <input name="avatar" type="file" accept="image/*" @change="pickFile"
                         class="mt-1 block w-full text-sm file:mr-4 file:rounded-lg file:border-0 file:bg-neutral-900 file:px-4 file:py-2 file:text-white hover:file:opacity-90 cursor-pointer" />
                  <p class="mt-1 text-xs text-neutral-500 truncate" x-text="avatarName"></p>
                </label>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <label class="block">
                <span class="text-sm text-neutral-600">Phone</span>
                <input name="phone" type="text" value="{{ request.user.phone }}"
                       placeholder="เช่น 08xxxxxxxx"
                       class="mt-1 w-full rounded-xl border border-neutral-300 bg-white px-3 py-2 focus:outline-none focus:ring-4 focus:ring-neutral-900/10 focus:border-neutral-900" />
              </label>

              <label class="block md:col-span-2">
                <span class="text-sm text-neutral-600">Address</span>
                <textarea name="address" rows="3" placeholder="ที่อยู่สำหรับติดต่อ/จัดส่ง"
                          class="mt-1 w-full rounded-xl border border-neutral-300 bg-white px-3 py-2 focus:outline-none focus:ring-4 focus:ring-neutral-900/10 focus:border-neutral-900">{{ request.user.address }}</textarea>
              </label>
            </div>
          </div>

          <div class="bg-neutral-50 px-6 py-4 flex items-center justify-end gap-3">
            <button type="button" @click="showEdit=false" class="rounded-xl px-4 py-2 bg-neutral-200 hover:bg-neutral-300">Cancel</button>
            <button class="rounded-xl px-5 py-2.5 bg-neutral-900 text-white hover:opacity-90 shadow">Save</button>
          </div>
        </div>
      </form>
    </div>

    <!-- Modal: Delete Account -->
    {% url 'account_delete' as account_delete_url %}
    <div x-show="showDelete" x-cloak
         class="fixed inset-0 z-50 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4">

      {% if account_delete_url %}
      <!-- กรณีมี route account_delete แล้ว -->
      <form method="post" action="{{ account_delete_url }}" class="w-full max-w-lg"
            @submit="if(delInput !== '{{ request.user.username }}'){ $event.preventDefault(); }">
        {% csrf_token %}
        <div class="rounded-2xl overflow-hidden shadow-2xl">
          <div class="bg-red-600 text-white px-6 py-4 flex items-center justify-between">
            <h3 class="text-xl font-semibold">Delete account</h3>
            <button type="button" @click="showDelete=false" class="rounded-md bg-white/20 px-3 py-1.5 hover:bg-white/30">✕</button>
          </div>

          <div class="bg-white px-6 py-6 space-y-4">
            <p class="text-sm text-red-700 bg-red-50 border border-red-200 p-3 rounded-lg">
              การลบบัญชีเป็นการกระทำที่ <b>ย้อนกลับไม่ได้</b><br>
              ข้อมูลที่เชื่อมกับบัญชีนี้ (เช่น pets, ประวัควัคซีน/แพ้) อาจถูกลบไปด้วย
            </p>

            <div>
              <label class="block text-sm text-gray-700 mb-1">
                พิมพ์ชื่อผู้ใช้ <b>{{ request.user.username }}</b> เพื่อยืนยัน
              </label>
              <input type="text" name="confirm" x-model="delInput"
                     placeholder="{{ request.user.username }}"
                     class="w-full rounded-xl border border-gray-300 px-3 py-2 focus:outline-none focus:ring-4 focus:ring-red-600/10 focus:border-red-600">
            </div>
          </div>

          <div class="bg-neutral-50 px-6 py-4 flex items-center justify-between">
            <button type="button" @click="showDelete=false" class="rounded-xl px-4 py-2 bg-neutral-200 hover:bg-neutral-300">
              Cancel
            </button>
            <button type="submit"
                    :disabled="delInput !== '{{ request.user.username }}'"
                    :class="delInput === '{{ request.user.username }}' ? 'bg-red-600 hover:bg-red-700 cursor-pointer' : 'bg-red-300 cursor-not-allowed'"
                    class="rounded-xl px-5 py-2.5 text-white shadow">
              Permanently delete
            </button>
          </div>
        </div>
      </form>

      {% else %}
      <!-- กรณียังไม่มี route account_delete: ป้องกัน error และบอกวิธีเปิดใช้ -->
      <div class="w-full max-w-lg">
        <div class="rounded-2xl overflow-hidden shadow-2xl">
          <div class="bg-red-600 text-white px-6 py-4 flex items-center justify-between">
            <h3 class="text-xl font-semibold">Delete account</h3>
            <button type="button" @click="showDelete=false" class="rounded-md bg-white/20 px-3 py-1.5 hover:bg-white/30">✕</button>
          </div>
          <div class="bg-white px-6 py-6 space-y-4">
            <p class="text-sm text-red-700 bg-red-50 border border-red-200 p-3 rounded-lg">
              ยังไม่ได้กำหนดเส้นทาง <code>account_delete</code> ใน <b>urls.py</b> จึงไม่สามารถลบบัญชีได้ตอนนี้<br>
              โปรดเพิ่ม
              <code class="bg-neutral-100 px-2 py-0.5 rounded">path("accounts/delete/", views.account_delete, name="account_delete")</code>
              และ view <code>account_delete</code> แล้วกลับมาลองใหม่อีกครั้ง
            </p>
            <div class="text-right">
              <button type="button" @click="showDelete=false" class="rounded-xl px-4 py-2 bg-neutral-200 hover:bg-neutral-300">Close</button>
            </div>
          </div>
        </div>
      </div>
      {% endif %}

    </div>

  </main>
</body>
</html>
